import Inputmask from"../inputmask";import keyCode from"../keycode.json";import escapeRegex from"../escapeRegex";import{seekNext}from"../positioning";import{getMaskTemplate}from"../validation-tests";const $=Inputmask.dependencyLib;class DateObject{constructor(t,e,a){this.mask=t,this.format=e,this.opts=a,this._date=new Date(1,0,1),this.initDateObject(t,this.opts)}get date(){return void 0===this._date&&(this._date=new Date(1,0,1),this.initDateObject(void 0,this.opts)),this._date}initDateObject(t,e){let a;for(getTokenizer(e).lastIndex=0;a=getTokenizer(e).exec(this.format);){let r,o=new RegExp("\\d+$").exec(a[0]),n=o?a[0][0]+"x":a[0];if(void 0!==t){if(o){let o=getTokenizer(e).lastIndex,n=getTokenMatch(a.index,e);getTokenizer(e).lastIndex=o,r=t.slice(0,t.indexOf(n.nextMatch[0]))}else r=t.slice(0,formatCode[n]&&formatCode[n][4]||n.length);t=t.slice(r.length)}Object.prototype.hasOwnProperty.call(formatCode,n)&&this.setValue(this,r,n,formatCode[n][2],formatCode[n][1])}}setValue(t,e,a,r,o){if(void 0!==e&&(t[r]="ampm"===r?e:e.replace(/[^0-9]/g,"0"),t["raw"+r]=e.replace(/\s/g,"_")),void 0!==o){let e=t[r];("day"===r&&29===parseInt(e)||"month"===r&&2===parseInt(e))&&(29!==parseInt(t.day)||2!==parseInt(t.month)||""!==t.year&&void 0!==t.year||t._date.setFullYear(2012,1,29)),"day"===r&&(useDateObject=!0,0===parseInt(e)&&(e=1)),"month"===r&&(useDateObject=!0),"year"===r&&(useDateObject=!0,e.length<4&&(e=pad(e,4,!0))),""===e||isNaN(e)||o.call(t._date,e),"ampm"===r&&o.call(t._date,e)}}reset(){this._date=new Date(1,0,1)}reInit(){this._date=void 0,this.date}}let currentYear=(new Date).getFullYear(),useDateObject=!1,formatCode={d:["[1-9]|[12][0-9]|3[01]",Date.prototype.setDate,"day",Date.prototype.getDate],dd:["0[1-9]|[12][0-9]|3[01]",Date.prototype.setDate,"day",function(){return pad(Date.prototype.getDate.call(this),2)}],ddd:[""],dddd:[""],m:["[1-9]|1[012]",function(t){let e=t?parseInt(t):0;return e>0&&e--,Date.prototype.setMonth.call(this,e)},"month",function(){return Date.prototype.getMonth.call(this)+1}],mm:["0[1-9]|1[012]",function(t){let e=t?parseInt(t):0;return e>0&&e--,Date.prototype.setMonth.call(this,e)},"month",function(){return pad(Date.prototype.getMonth.call(this)+1,2)}],mmm:[""],mmmm:[""],yy:["[0-9]{2}",Date.prototype.setFullYear,"year",function(){return pad(Date.prototype.getFullYear.call(this),2)}],yyyy:["[0-9]{4}",Date.prototype.setFullYear,"year",function(){return pad(Date.prototype.getFullYear.call(this),4)}],h:["[1-9]|1[0-2]",Date.prototype.setHours,"hours",Date.prototype.getHours],hh:["0[1-9]|1[0-2]",Date.prototype.setHours,"hours",function(){return pad(Date.prototype.getHours.call(this),2)}],hx:[function(t){return`[0-9]{${t}}`},Date.prototype.setHours,"hours",function(t){return Date.prototype.getHours}],H:["1?[0-9]|2[0-3]",Date.prototype.setHours,"hours",Date.prototype.getHours],HH:["0[0-9]|1[0-9]|2[0-3]",Date.prototype.setHours,"hours",function(){return pad(Date.prototype.getHours.call(this),2)}],Hx:[function(t){return`[0-9]{${t}}`},Date.prototype.setHours,"hours",function(t){return function(){return pad(Date.prototype.getHours.call(this),t)}}],M:["[1-5]?[0-9]",Date.prototype.setMinutes,"minutes",Date.prototype.getMinutes],MM:["0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]",Date.prototype.setMinutes,"minutes",function(){return pad(Date.prototype.getMinutes.call(this),2)}],s:["[1-5]?[0-9]",Date.prototype.setSeconds,"seconds",Date.prototype.getSeconds],ss:["0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]",Date.prototype.setSeconds,"seconds",function(){return pad(Date.prototype.getSeconds.call(this),2)}],l:["[0-9]{3}",Date.prototype.setMilliseconds,"milliseconds",function(){return pad(Date.prototype.getMilliseconds.call(this),3)},3],L:["[0-9]{2}",Date.prototype.setMilliseconds,"milliseconds",function(){return pad(Date.prototype.getMilliseconds.call(this),2)},2],t:["[ap]",setAMPM,"ampm",getAMPM,1],tt:["[ap]m",setAMPM,"ampm",getAMPM,2],T:["[AP]",setAMPM,"ampm",getAMPM,1],TT:["[AP]M",setAMPM,"ampm",getAMPM,2],Z:[".*",void 0,"Z",getTimeZoneAbbreviated],o:[""],S:[""]},formatAlias={isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};function setAMPM(t){const e=this.getHours();t.toLowerCase().includes("p")?this.setHours(e+12):t.toLowerCase().includes("a")&&e>=12&&this.setHours(e-12)}function getAMPM(){let t=this.getHours();return t=t||12,t>=12?"PM":"AM"}function getTimeZoneAbbreviated(){let{1:t}=this.toString().match(/\((.+)\)/);return t.includes(" ")&&(t=t.replace("-"," ").toUpperCase(),t=t.split(" ").map((([t])=>t)).join("")),t}function formatcode(t){var e=new RegExp("\\d+$").exec(t[0]);if(e&&void 0!==e[0]){var a=formatCode[t[0][0]+"x"].slice("");return a[0]=a[0](e[0]),a[3]=a[3](e[0]),a}if(formatCode[t[0]])return formatCode[t[0]]}function getTokenizer(t){if(!t.tokenizer){var e=[],a=[];for(var r in formatCode)if(/\.*x$/.test(r)){var o=r[0]+"\\d+";-1===a.indexOf(o)&&a.push(o)}else-1===e.indexOf(r[0])&&e.push(r[0]);t.tokenizer="("+(a.length>0?a.join("|")+"|":"")+e.join("+|")+")+?|.",t.tokenizer=new RegExp(t.tokenizer,"g")}return t.tokenizer}function prefillYear(t,e,a){if(t.year!==t.rawyear){var r=currentYear.toString(),o=t.rawyear.replace(/[^0-9]/g,""),n=r.slice(0,o.length),i=r.slice(o.length);if(2===o.length&&o===n){const o=new Date(currentYear,t.month-1,t.day);t.day==o.getDate()&&(!a.max||a.max.date.getTime()>=o.getTime())&&(t.date.setFullYear(currentYear),t.year=r,e.insert=[{pos:e.pos+1,c:i[0]},{pos:e.pos+2,c:i[1]}])}}return e}function isValidDate(t,e,a){if(!useDateObject)return!0;if(void 0===t.rawday||!isFinite(t.rawday)&&new Date(t.date.getFullYear(),isFinite(t.rawmonth)?t.month:t.date.getMonth()+1,0).getDate()>=t.day||"29"==t.day&&(!isFinite(t.rawyear)||void 0===t.rawyear||""===t.rawyear)||new Date(t.date.getFullYear(),isFinite(t.rawmonth)?t.month:t.date.getMonth()+1,0).getDate()>=t.day)return e;if("29"==t.day){var r=getTokenMatch(e.pos,a);if("yyyy"===r.targetMatch[0]&&e.pos-r.targetMatchIndex==2)return e.remove=e.pos+1,e}else if("02"==t.month&&"30"==t.day&&void 0!==e.c)return t.day="03",t.date.setDate(3),t.date.setMonth(1),e.insert=[{pos:e.pos,c:"0"},{pos:e.pos+1,c:e.c}],e.caret=seekNext.call(this,e.pos+1),e;return!1}function isDateInRange(t,e,a,r,o){if(!e)return e;if(e&&a.min&&!isNaN(a.min.date.getTime())){let o;for(t.reset(),getTokenizer(a).lastIndex=0;o=getTokenizer(a).exec(a.inputFormat);){var n;if((n=formatcode(o))&&n[3]){var i=n[1],s=t[n[2]],p=a.min[n[2]],d=a.max?a.max[n[2]]:p,u=[];let e=!1;for(let i=0;i<p.length;i++)void 0!==r.validPositions[i+o.index]||e?(u[i]=s[i],e=e||s[i]>p[i]):(u[i]=p[i],"year"===n[2]&&s.length-1==i&&p!=d&&(u=(parseInt(u.join(""))+1).toString().split("")),"ampm"===n[2]&&p!=d&&a.min.date.getTime()>t.date.getTime()&&(u[i]=d[i]));i.call(t._date,u.join(""))}}e=a.min.date.getTime()<=t.date.getTime(),t.reInit()}return e&&a.max&&(isNaN(a.max.date.getTime())||(e=a.max.date.getTime()>=t.date.getTime())),e}function parse(t,e,a,r){var o,n,i="";for(getTokenizer(a).lastIndex=0;o=getTokenizer(a).exec(t);)if(void 0===e)if(n=formatcode(o))i+="("+n[0]+")";else switch(o[0]){case"[":i+="(";break;case"]":i+=")?";break;default:i+=escapeRegex(o[0])}else(n=formatcode(o))?!0!==r&&n[3]?i+=n[3].call(e.date):n[2]?i+=e["raw"+n[2]]:i+=o[0]:i+=o[0];return i}function pad(t,e,a){for(t=String(t),e=e||2;t.length<e;)t=a?t+"0":"0"+t;return t}function analyseMask(t,e,a){return"string"==typeof t?new DateObject(t,e,a):t&&"object"==typeof t&&Object.prototype.hasOwnProperty.call(t,"date")?t:void 0}function importDate(t,e){return parse(e.inputFormat,{date:t},e)}function getTokenMatch(t,e){var a,r,o=0,n=0;for(getTokenizer(e).lastIndex=0;r=getTokenizer(e).exec(e.inputFormat);){var i=new RegExp("\\d+$").exec(r[0]);if((o+=n=i?parseInt(i[0]):r[0].length)>=t+1){a=r,r=getTokenizer(e).exec(e.inputFormat);break}}return{targetMatchIndex:o-n,nextMatch:r,targetMatch:a}}Inputmask.extendAliases({datetime:{mask:function(t){return t.numericInput=!1,formatCode.S=t.i18n.ordinalSuffix.join("|"),t.inputFormat=formatAlias[t.inputFormat]||t.inputFormat,t.displayFormat=formatAlias[t.displayFormat]||t.displayFormat||t.inputFormat,t.outputFormat=formatAlias[t.outputFormat]||t.outputFormat||t.inputFormat,t.placeholder=""!==t.placeholder?t.placeholder:t.inputFormat.replace(/[[\]]/,""),t.regex=parse(t.inputFormat,void 0,t),t.min=analyseMask(t.min,t.inputFormat,t),t.max=analyseMask(t.max,t.inputFormat,t),null},placeholder:"",inputFormat:"isoDateTime",displayFormat:null,outputFormat:null,min:null,max:null,skipOptionalPartCharacter:"",i18n:{dayNames:["Mon","Tue","Wed","Thu","Fri","Sat","Sun","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"],ordinalSuffix:["st","nd","rd","th"]},preValidation:function(t,e,a,r,o,n,i,s){if(s)return!0;if(isNaN(a)&&t[e]!==a){var p=getTokenMatch(e,o);if(p.nextMatch&&p.nextMatch[0]===a&&p.targetMatch[0].length>1){var d=formatCode[p.targetMatch[0]][0];if(new RegExp(d).test("0"+t[e-1]))return t[e]=t[e-1],t[e-1]="0",{fuzzy:!0,buffer:t,refreshFromBuffer:{start:e-1,end:e+1},pos:e+1}}}return!0},postValidation:function(t,e,a,r,o,n,i,s){const p=this;if(i)return!0;var d,u;if(!1===r&&(((d=getTokenMatch(e+1,o)).targetMatch&&d.targetMatchIndex===e&&d.targetMatch[0].length>1&&void 0!==formatCode[d.targetMatch[0]]||(d=getTokenMatch(e+2,o)).targetMatch&&d.targetMatchIndex===e+1&&d.targetMatch[0].length>1&&void 0!==formatCode[d.targetMatch[0]])&&(u=formatCode[d.targetMatch[0]][0]),void 0!==u&&(void 0!==n.validPositions[e+1]&&new RegExp(u).test(a+"0")?(t[e]=a,t[e+1]="0",r={pos:e+2,caret:e}):new RegExp(u).test("0"+a)&&(t[e]="0",t[e+1]=a,r={pos:e+2})),!1===r))return r;if(r.fuzzy&&(t=r.buffer,e=r.pos),(d=getTokenMatch(e,o)).targetMatch&&d.targetMatch[0]&&void 0!==formatCode[d.targetMatch[0]]){let a=formatCode[d.targetMatch[0]];u=a[0];var l=t.slice(d.targetMatchIndex,d.targetMatchIndex+d.targetMatch[0].length);if(!1===new RegExp(u).test(l.join(""))&&2===d.targetMatch[0].length&&n.validPositions[d.targetMatchIndex]&&n.validPositions[d.targetMatchIndex+1]&&(n.validPositions[d.targetMatchIndex+1].input="0"),"year"==a[2]){var c=getMaskTemplate.call(p,!1,1,void 0,!0);for(let a=e+1;a<t.length;a++)t[a]=c[a],delete n.validPositions[a]}}var m=r,g=analyseMask(t.join(""),o.inputFormat,o);return m&&!isNaN(g.date.getTime())&&(o.prefillYear&&(m=prefillYear(g,m,o)),m=isDateInRange(g,m=isValidDate.call(p,g,m,o),o,n,s)),void 0!==e&&m&&r.pos!==e?{buffer:parse(o.inputFormat,g,o).split(""),refreshFromBuffer:{start:e,end:r.pos},pos:r.caret||r.pos}:m},onKeyDown:function(t,e,a,r){t.ctrlKey&&t.keyCode===keyCode.RIGHT&&(this.inputmask._valueSet(importDate(new Date,r)),$(this).trigger("setvalue"))},onUnMask:function(t,e,a){return e?parse(a.outputFormat,analyseMask(t,a.inputFormat,a),a,!0):e},casing:function(t,e,a,r){return 0==e.nativeDef.indexOf("[ap]")?t.toLowerCase():0==e.nativeDef.indexOf("[AP]")?t.toUpperCase():t},onBeforeMask:function(t,e){return"[object Date]"===Object.prototype.toString.call(t)&&(t=importDate(t,e)),t},insertMode:!1,shiftPositions:!1,keepStatic:!1,inputmode:"numeric",prefillYear:!0}});